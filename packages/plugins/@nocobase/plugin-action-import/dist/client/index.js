/**
 * This file is part of the NocoBase (R) project.
 * Copyright (c) 2020-2024 NocoBase Co., Ltd.
 * Authors: NocoBase Team.
 *
 * This project is dual-licensed under AGPL-3.0 and NocoBase Commercial License.
 * For more information, please refer to: https://www.nocobase.com/agreement.
 */

!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("react-i18next"),require("react-dom"),require("@emotion/css"),require("@formily/shared"),require("file-saver"),require("@nocobase/utils/client"),require("@nocobase/client"),require("lodash"),require("antd"),require("@ant-design/icons"),require("@formily/react"),require("@formily/antd-v5"),require("react")):"function"==typeof define&&define.amd?define("@nocobase/plugin-action-import",["react-i18next","react-dom","@emotion/css","@formily/shared","file-saver","@nocobase/utils/client","@nocobase/client","lodash","antd","@ant-design/icons","@formily/react","@formily/antd-v5","react"],t):"object"==typeof exports?exports["@nocobase/plugin-action-import"]=t(require("react-i18next"),require("react-dom"),require("@emotion/css"),require("@formily/shared"),require("file-saver"),require("@nocobase/utils/client"),require("@nocobase/client"),require("lodash"),require("antd"),require("@ant-design/icons"),require("@formily/react"),require("@formily/antd-v5"),require("react")):e["@nocobase/plugin-action-import"]=t(e["react-i18next"],e["react-dom"],e["@emotion/css"],e["@formily/shared"],e["file-saver"],e["@nocobase/utils/client"],e["@nocobase/client"],e.lodash,e.antd,e["@ant-design/icons"],e["@formily/react"],e["@formily/antd-v5"],e.react)}(self,function(e,t,n,r,o,i,a,l,c,u,s,p,f){return function(){"use strict";var d={482:function(e){e.exports=u},964:function(e){e.exports=n},632:function(e){e.exports=p},505:function(e){e.exports=s},875:function(e){e.exports=r},772:function(e){e.exports=a},584:function(e){e.exports=i},721:function(e){e.exports=c},346:function(e){e.exports=o},467:function(e){e.exports=l},156:function(e){e.exports=f},111:function(e){e.exports=t},238:function(t){t.exports=e}},m={};function y(e){var t=m[e];if(void 0!==t)return t.exports;var n=m[e]={exports:{}};return d[e](n,n.exports,y),n.exports}y.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return y.d(t,{a:t}),t},y.d=function(e,t){for(var n in t)y.o(t,n)&&!y.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},y.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},y.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var v={};y.r(v),y.d(v,{ImportActionInitializer:function(){return E},PluginActionImportClient:function(){return eT},default:function(){return eD},useDownloadXlsxTemplateAction:function(){return ea},useImportStartAction:function(){return el},ImportDesigner:function(){return $},ImportPluginProvider:function(){return eb},ImportWarning:function(){return T},DownloadTips:function(){return D},ImportContextProvider:function(){return eh},initImportSettings:function(){return C}});var b=y("875"),h=y("772"),g=y("156"),x=y.n(g),S=y("238");function I(){return(0,S.useTranslation)(["action-import","client"],{nsMode:"fallback"})}function O(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var w=["id","createdAt","createdBy","updatedAt","updatedBy"],A=function(e){var t=(0,h.useCollectionManager_deprecated)().getCollectionFields,n=t(e),r=function(e,n){if(!(!e.interface||w.includes(e.interface))){var r={name:e.name,title:(null==e?void 0:null===(i=e.uiSchema)||void 0===i?void 0:i.title)||e.name,schema:null==e?void 0:e.uiSchema};if(!e.target||n>=2)return r;if(e.target&&["hasOne","hasMany","belongsTo","belongsToMany","belongsToArray"].includes(e.type)){var i,a,l,c=o(t(e.target),n+1).filter(Boolean);r.children=r.children||[],(a=r.children).push.apply(a,function(e){if(Array.isArray(e))return O(e)}(l=c)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(l)||function(e,t){if(e){if("string"==typeof e)return O(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return O(e,t)}}(l)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())}return r}},o=function(e,t){var n=[];return e.forEach(function(e){var o=r(e,t);o&&n.push(o)}),n};return o(n,1)},j=y("721"),P=y("584"),C=function(e){return{importColumns:null==e?void 0:e.filter(function(e){return!e.children}).map(function(e){return{dataIndex:[e.name]}}),explain:""}},E=function(){var e=(0,h.useSchemaInitializerItem)(),t=(0,h.useSchemaInitializer)().insert,n=A((0,h.useCollection_deprecated)().name),r={type:"void",title:'{{ t("Import") }}',"x-component":"ImportAction","x-action":"importXlsx","x-settings":"actionSettings:import","x-toolbar":"ActionSchemaToolbar"};return x().createElement(h.SchemaInitializerItem,{title:e.title,onClick:function(){P.lodash.set(r,"x-action-settings.importSettings",C(n));var o,i=(0,b.merge)(r||{},e.schema||{});null==e||null===(o=e.schemaInitialize)||void 0===o||o.call(e,i),t(i)}})},T=function(){var e=I().t;return x().createElement(j.Alert,{type:"warning",style:{marginBottom:"10px"},message:e("Import warnings",{limit:15e3})})},D=function(){var e=I().t;return x().createElement(j.Alert,{type:"info",style:{marginBottom:"10px",whiteSpace:"pre-line"},message:e("Download tips")})},M=y("632"),k=y("505"),F="action-import";function q(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function R(e,t){return!t&&(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function B(){var e=R(["\n                    width: 100%;\n                    & .ant-space-item:nth-child(2) {\n                      flex: 1;\n                    }\n                  "]);return B=function(){return e},e}function z(){var e=R(["\n                  border-color: var(--colorSettings);\n                  color: var(--colorSettings);\n                  &.ant-btn-dashed:hover {\n                    border-color: var(--colorSettings);\n                    color: var(--colorSettings);\n                  }\n                "]);return z=function(){return e},e}var U=["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","application/wps-office.xlsx"],_=function(){var e=(0,S.useTranslation)(F).t,t=A((0,h.useCollection_deprecated)().name);return{importSettingsSchema:{type:"void","x-component":"Grid",properties:{explain:{type:"string",title:'{{ t("Import explain", {ns: "'.concat(F,'"}) }}'),"x-decorator":"FormItem","x-component":"Input.TextArea"},importColumns:{type:"array","x-component":"ArrayItems","x-decorator":"FormItem",items:{type:"object",properties:{space:{type:"void","x-component":"Space","x-component-props":{className:(0,h.css)(B())},properties:{sort:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.SortHandle"},dataIndex:{type:"array","x-decorator":"FormItem","x-component":h.Cascader,required:!0,enum:t,"x-component-props":{fieldNames:{label:"title",value:"name",children:"children"},changeOnSelect:!1}},title:{type:"string","x-decorator":"FormItem","x-component":"Input","x-component-props":{placeholder:'{{ t("Custom column title") }}'}},description:{type:"string","x-decorator":"FormItem","x-component":"Input","x-component-props":{placeholder:'{{ t("Field description placeholder", {ns: "'.concat(F,'"}) }}')}},remove:{type:"void","x-decorator":"FormItem","x-component":"ArrayItems.Remove"}}}}},properties:{add:{type:"void",title:'{{ t("Add importable field", {ns: "'.concat(F,'"}) }}'),"x-component":"ArrayItems.Addition","x-component-props":{className:(0,h.css)(z())}}}}}},beforeUploadHandler:function(){return!1},uploadValidator:function(t,n){if(t.length>1)return{type:"error",message:e("Only one file is allowed to be uploaded")};var r,o=null!==(r=t[0])&&void 0!==r?r:{};return o.size>0x5000000?{type:"error",message:e("File size cannot exceed 80M")}:U.includes(o.type)?"":{type:"error",message:e("Please upload the file of Excel")}},validateUpload:function(e,t,n){var r,o,i,a,l,c=(a=1,function(e){if(Array.isArray(e))return e}(i=n)||function(e,t){var n,r,o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var i=[],a=!0,l=!1;try{for(o=o.call(e);!(a=(n=o.next()).done)&&(i.push(n.value),!t||i.length!==t);a=!0);}catch(e){l=!0,r=e}finally{try{!a&&null!=o.return&&o.return()}finally{if(l)throw r}}return i}}(i,1)||function(e,t){if(e){if("string"==typeof e)return q(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return q(e,t)}}(i,a)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())[0];t.disabled=(null==c?void 0:c.length)===0,t.componentProps=(r=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){var r,o,i;r=e,o=t,i=n[t],o in r?Object.defineProperty(r,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):r[o]=i})}return e}({},t.componentProps),o=(o={disabled:(null==c?void 0:c.length)===0||(null===(l=e.errors)||void 0===l?void 0:l.length)>0},o),Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(o)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n.push.apply(n,r)}return n})(Object(o)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(o,e))}),r)}}};function N(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function V(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function G(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){V(e,t,n[t])})}return e}var $=function(){var e,t,n,r,o,i,a,l,c=(0,k.useField)(),u=(0,k.useFieldSchema)(),s=(0,S.useTranslation)().t,p=(0,h.useDesignable)().dn;var f=(e=(0,g.useState)(),t=2,function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n,r,o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var i=[],a=!0,l=!1;try{for(o=o.call(e);!(a=(n=o.next()).done)&&(i.push(n.value),!t||i.length!==t);a=!0);}catch(e){l=!0,r=e}finally{try{!a&&null!=o.return&&o.return()}finally{if(l)throw r}}return i}}(e,2)||function(e,t){if(e){if("string"==typeof e)return N(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return N(e,t)}}(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),d=f[0],m=f[1],y=_().importSettingsSchema;return(0,g.useEffect)(function(){m(y)},[c.address,null==u?void 0:null===(n=u["x-action-settings"])||void 0===n?void 0:n.importSettings]),x().createElement(h.GeneralSchemaDesigner,{disableInitializer:!0},x().createElement(h.SchemaSettingsModalItem,{title:s("Edit button"),schema:{type:"object",title:s("Edit button"),properties:{title:{"x-decorator":"FormItem","x-component":"Input",title:s("Button title"),default:u.title,"x-component-props":{}},icon:{"x-decorator":"FormItem","x-component":"IconPicker",title:s("Button icon"),default:null==u?void 0:null===(r=u["x-component-props"])||void 0===r?void 0:r.icon,"x-component-props":{}},type:{"x-decorator":"FormItem","x-component":"Radio.Group",title:s("Button background color"),default:(null==u?void 0:null===(o=u["x-component-props"])||void 0===o?void 0:o.danger)?"danger":(null==u?void 0:null===(i=u["x-component-props"])||void 0===i?void 0:i.type)==="primary"?"primary":"default",enum:[{value:"default",label:'{{t("Default")}}'},{value:"primary",label:'{{t("Highlight")}}'},{value:"danger",label:'{{t("Danger red")}}'}]}}},onSubmit:function(e){var t,n=e.title,r=e.icon,o=e.type;u.title=n,c.title=n,c.componentProps.icon=r,c.componentProps.danger="danger"===o,c.componentProps.type=o,u["x-component-props"]=u["x-component-props"]||{},u["x-component-props"].icon=r,u["x-component-props"].danger="danger"===o,u["x-component-props"].type=o,p.emit("patch",{schema:(V(t={},"x-uid",u["x-uid"]),V(t,"title",n),V(t,"x-component-props",G({},u["x-component-props"])),t)}),p.refresh()}}),x().createElement(h.SchemaSettingsActionModalItem,{title:s("Importable fields"),schema:d,initialValues:G({},null!==(l=null==u?void 0:null===(a=u["x-action-settings"])||void 0===a?void 0:a.importSettings)&&void 0!==l?l:{}),components:{ArrayItems:M.ArrayItems},onSubmit:function(e){var t,n=e.importColumns,r=e.explain,o=null==n?void 0:n.filter(function(e){var t;return null==e?void 0:null===(t=e.dataIndex)||void 0===t?void 0:t.length}).map(function(e){return{dataIndex:e.dataIndex.map(function(e){var t;return null!==(t=e.name)&&void 0!==t?t:e}),title:e.title}});u["x-action-settings"].importSettings={importColumns:o,explain:r},p.emit("patch",{schema:(V(t={},"x-uid",u["x-uid"]),V(t,"x-action-settings",u["x-action-settings"]),t)}),p.refresh()}}),x().createElement(h.SchemaSettingsDivider,null),x().createElement(h.SchemaSettingsRemove,{removeParentsIfNoChildren:!0,breakRemoveOn:function(e){return"Space"===e["x-component"]||e["x-component"].endsWith("ActionBar")},confirm:{title:s("Delete action")}}))},X=y("111"),H=(0,g.createContext)(null);H.displayName="ImportContext";var W=function(){return(0,g.useContext)(H)},L=y("482"),J=y("346");function K(){var e,t,n=(e=["\n          display: flex;\n          justify-content: center;\n          align-items: center;\n          height: 100%;\n        "],!t&&(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}})));return K=function(){return n},n}var Q={IMPORTING:1,IMPORTED:2},Y=function(e){var t=(0,S.useTranslation)(F).t,n=W(),r=n.importModalVisible,o=n.importStatus,i=n.importResult,a=n.setImportModalVisible,l=null!=i?i:{},c=l.data,u=l.meta,s=function(){a(!1)};return x().createElement(j.Modal,{title:t("Import Data"),width:"50%",styles:{body:{height:"calc(80vh - 200px)"}},open:r,footer:null,closable:o===Q.IMPORTED,onCancel:s},x().createElement("div",{className:(0,h.css)(K())},o===Q.IMPORTING&&x().createElement(j.Spin,{indicator:x().createElement(L.LoadingOutlined,{style:{fontSize:24},spin:!0}),tip:t("Excel data importing")}),o===Q.IMPORTED&&x().createElement(j.Space,{direction:"vertical",align:"center"},x().createElement(L.ExclamationCircleFilled,{style:{fontSize:72,color:"#1890ff"}}),x().createElement("p",null,function(e){if(!e)return null;var n=e.data,r=e.meta;if(r)return t("{{successCount}} records have been successfully imported",function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){var r,o,i;r=e,o=t,i=n[t],o in r?Object.defineProperty(r,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):r[o]=i})}return e}({},null!=r?r:{}));var o=["".concat(t("Total records"),": ").concat(n.total||0),"".concat(t("Successfully imported"),": ").concat(n.success||0)];return n.skipped>0&&o.push("".concat(t("Skipped"),": ").concat(n.skipped)),n.updated>0&&o.push("".concat(t("Updated"),": ").concat(n.updated)),o.join(", ")}(i)),x().createElement(j.Space,null,(null==u?void 0:u.failureCount)>0&&x().createElement(j.Button,{onClick:function(){var e=new Blob([new Int8Array(null==c?void 0:c.data)],{type:"application/x-xls"});(0,J.saveAs)(e,"fail.xlsx")}},t("To download the failure data")),x().createElement(j.Button,{type:"primary",onClick:s},t("Done"))))))},Z=y("467"),ee=y.n(Z);function et(e,t,n,r,o,i,a){try{var l=e[i](a),c=l.value}catch(e){n(e);return}l.done?t(c):Promise.resolve(c).then(r,o)}function en(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){et(i,r,o,a,l,"next",e)}function l(e){et(i,r,o,a,l,"throw",e)}a(void 0)})}}function er(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(i){return function(l){return function(i){if(n)throw TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,l])}}}var eo=function(){for(var e=(0,h.useActionContext)().fieldSchema,t=(0,k.useFieldSchema)(),n=e||t;n&&"importXlsx"!==n["x-action"];)console.log("schema",n=n.parent);return{schema:n}},ei=function(e){return e&&Array.isArray(e)?e:[]},ea=function(){var e=(0,h.useBlockRequestContext)().resource,t=(0,h.useCompile)(),n=(0,h.useCollectionManager_deprecated)(),r=n.getCollectionJoinField,o=n.getCollectionField,i=(0,h.useCollection_deprecated)(),a=i.name,l=i.title,c=eo().schema;return{run:function(){return en(function(){var n,i,u,s,p,f,d;return er(this,function(m){switch(m.label){case 0:return s=(u=ee().cloneDeep(null!==(i=null==c?void 0:null===(n=c["x-action-settings"])||void 0===n?void 0:n.importSettings)&&void 0!==i?i:{})).importColumns,p=u.explain,f=ei(s).map(function(e){var n=o("".concat(a,".").concat(e.dataIndex[0]));if(!!n){if(e.defaultTitle=t(null==n?void 0:null===(i=n.uiSchema)||void 0===i?void 0:i.title)||n.name,e.dataIndex.length>1){var i,l,c=r("".concat(a,".").concat(e.dataIndex.join(".")));if(!c)return;e.defaultTitle=e.defaultTitle+"/"+t(null==c?void 0:null===(l=c.uiSchema)||void 0===l?void 0:l.title)||c.name}return"chinaRegion"===n.interface&&e.dataIndex.push("name"),e}}).filter(Boolean),[4,e.downloadXlsxTemplate({values:{title:t(l),explain:p,columns:t(f)}},{method:"post",responseType:"blob"})];case 1:return d=new Blob([m.sent().data],{type:"application/x-xls"}),(0,J.saveAs)(d,"".concat(t(l),".xlsx")),[2]}})})()}}},el=function(){var e,t=(0,h.useBlockRequestContext)().service,n=(0,h.useCompile)(),r=(0,h.useCollectionManager_deprecated)(),o=r.getCollectionJoinField,i=r.getCollectionField,a=(0,h.useCollection_deprecated)().name,l=eo().schema,c=(0,k.useForm)(),u=(0,h.useActionContext)().setVisible,s=W(),p=s.setImportModalVisible,f=s.setImportStatus,d=s.setImportResult,m=c.values.upload,y=(0,h.useDataBlockResource)();return(0,g.useEffect)(function(){c.reset()},[]),{run:function(){return en(function(){var e,r,s,m,v,b,h,g,x,S,I,O,w;return er(this,function(w){switch(w.label){case 0:v=(m=ee().cloneDeep(null!==(s=null==l?void 0:null===(e=l["x-action-settings"])||void 0===e?void 0:e.importSettings)&&void 0!==s?s:{})).importColumns,b=m.explain,h=ei(v).map(function(e){var t=i("".concat(a,".").concat(e.dataIndex[0]));if(!!t){if(e.defaultTitle=n(null==t?void 0:null===(r=t.uiSchema)||void 0===r?void 0:r.title)||t.name,e.dataIndex.length>1){var r,l,c=o("".concat(a,".").concat(e.dataIndex.join(".")));if(!c)return;e.defaultTitle=e.defaultTitle+"/"+n(null==c?void 0:null===(l=c.uiSchema)||void 0===l?void 0:l.title)||c.name}return"chinaRegion"===t.interface&&e.dataIndex.push("name"),e}}).filter(Boolean),g=new FormData,x=c.values.upload.map(function(e){return e.originFileObj}),g.append("file",x[0]),g.append("columns",JSON.stringify(h)),g.append("explain",b),S=(null==l?void 0:null===(r=l["x-action-settings"])||void 0===r?void 0:r.importMode)||"auto",u(!1),p(!0),f(Q.IMPORTING),w.label=1;case 1:return w.trys.push([1,6,,7]),[4,y.importXlsx({values:g,mode:S},{timeout:6e5})];case 2:if(I=w.sent().data,c.reset(),I.data.taskId)return[3,4];return d(I),[4,null==t?void 0:null===(O=t.refresh)||void 0===O?void 0:O.call(t)];case 3:return w.sent(),f(Q.IMPORTED),[3,5];case 4:p(!1),u(!1),w.label=5;case 5:return[3,7];case 6:return w.sent(),p(!1),u(!0),[3,7];case 7:return[2]}})})()},disabled:(null==m?void 0:m.length)===0||(null===(e=c.errors)||void 0===e?void 0:e.length)>0}},ec=y("964");function eu(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function es(e,t){return!t&&(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function ep(){var e=es(["\n      .ant-formily-item-label {\n        height: var(--controlHeightLG);\n      }\n    "]);return ep=function(){return e},e}function ef(){var e=es(["\n                  margin-top: 5px;\n                "]);return ef=function(){return e},e}var ed={type:"void",name:"import-modal",title:'{{ t("Import Data", {ns: "'.concat(F,'" }) }}'),"x-component":"Action.Modal","x-decorator":"Form","x-component-props":{width:"100%",style:{maxWidth:"750px"},className:(0,ec.css)(ep())},properties:{formLayout:{type:"void","x-component":"FormLayout",properties:{warning:{type:"void","x-component":"ImportWarning"},download:{type:"void",title:'{{ t("Step 1: Download template", {ns: "'.concat(F,'" }) }}'),"x-component":"FormItem","x-acl-ignore":!0,properties:{tip:{type:"void","x-component":"DownloadTips"},downloadAction:{type:"void",title:'{{ t("Download template", {ns: "'.concat(F,'" }) }}'),"x-component":"Action","x-component-props":{className:(0,ec.css)(ef()),useAction:"{{ useDownloadXlsxTemplateAction }}"}}}},upload:{type:"array",title:'{{ t("Step 2: Upload Excel", {ns: "'.concat(F,'" }) }}'),"x-decorator":"FormItem","x-acl-ignore":!0,"x-component":"Upload.Dragger","x-validator":"{{ uploadValidator }}","x-component-props":{action:"",height:"150px",tipContent:'{{ t("Upload placeholder", {ns: "'.concat(F,'" }) }}'),beforeUpload:"{{ beforeUploadHandler }}"}}}},footer:{"x-component":"Action.Modal.Footer","x-component-props":{},properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{},properties:{cancel:{type:"void",title:'{{ t("Cancel") }}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},startImport:{type:"void",title:'{{ t("Start import", {ns: "'.concat(F,'" }) }}'),"x-component":"Action","x-component-props":{type:"primary",htmlType:"submit",useAction:"{{ useImportStartAction }}"},"x-reactions":{dependencies:["upload"],fulfill:{run:"validateUpload($form, $self, $deps)"}}}}}}}}},em=function(e){var t,n,r,o,i=(t=(0,g.useState)(!1),n=2,function(e){if(Array.isArray(e))return e}(t)||function(e,t){var n,r,o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var i=[],a=!0,l=!1;try{for(o=o.call(e);!(a=(n=o.next()).done)&&(i.push(n.value),!t||i.length!==t);a=!0);}catch(e){l=!0,r=e}finally{try{!a&&null!=o.return&&o.return()}finally{if(l)throw r}}return i}}(t,2)||function(e,t){if(e){if("string"==typeof e)return eu(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return eu(e,t)}}(t,n)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),a=i[0],l=i[1];(0,S.useTranslation)(F).t;var c=(0,h.useCompile)(),u=(0,k.useFieldSchema)();return x().createElement(h.ActionContextProvider,{value:{visible:a,setVisible:l,fieldSchema:u}},x().createElement(h.Action,(r=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){var r,o,i;r=e,o=t,i=n[t],o in r?Object.defineProperty(r,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):r[o]=i})}return e}({icon:e.icon||x().createElement(L.UploadOutlined,null),title:c((null==u?void 0:u.title)||"t('Import')")},e),o=(o={onClick:function(){return l(!0)}},o),Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(o)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n.push.apply(n,r)}return n})(Object(o)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(o,e))}),r)),x().createElement(h.SchemaComponent,{schema:ed}))};function ey(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function ev(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n,r,o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var i=[],a=!0,l=!1;try{for(o=o.call(e);!(a=(n=o.next()).done)&&(i.push(n.value),!t||i.length!==t);a=!0);}catch(e){l=!0,r=e}finally{try{!a&&null!=o.return&&o.return()}finally{if(l)throw r}}return i}}(e,t)||function(e,t){if(e){if("string"==typeof e)return ey(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ey(e,t)}}(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var eb=function(e){var t=_(),n=t.uploadValidator,r=t.beforeUploadHandler,o=t.validateUpload;return x().createElement(h.SchemaComponentOptions,{components:{ImportActionInitializer:E,ImportDesigner:$,ImportWarning:T,DownloadTips:D,ImportAction:em},scope:{uploadValidator:n,validateUpload:o,beforeUploadHandler:r,useDownloadXlsxTemplateAction:ea,useImportStartAction:el}},x().createElement(eh,null,e.children))},eh=function(e){var t=ev((0,g.useState)(!1),2),n=t[0],r=t[1],o=ev((0,g.useState)(Q.IMPORTING),2),i=o[0],a=o[1],l=ev((0,g.useState)(null),2),c=l[0],u=l[1];return x().createElement(H.Provider,{value:{importModalVisible:n,setImportModalVisible:r,importStatus:i,setImportStatus:a,importResult:c,setImportResult:u}},(0,X.createPortal)(x().createElement(Y,null),document.body),e.children)};function eg(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function ex(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function eS(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){ex(e,t,n[t])})}return e}var eI=new h.SchemaSettings({name:"actionSettings:import",items:[{name:"editButton",Component:h.ButtonEditor,useComponentProps:function(){return(0,h.useSchemaToolbar)().buttonEditorProps}},{name:"importableFields",type:"actionModal",useComponentProps:function(){var e,t,n,r,o,i=(0,k.useField)(),a=(0,k.useFieldSchema)(),l=(0,S.useTranslation)().t,c=(0,h.useDesignable)().dn;var u=(e=(0,g.useState)(),t=2,function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n,r,o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var i=[],a=!0,l=!1;try{for(o=o.call(e);!(a=(n=o.next()).done)&&(i.push(n.value),!t||i.length!==t);a=!0);}catch(e){l=!0,r=e}finally{try{!a&&null!=o.return&&o.return()}finally{if(l)throw r}}return i}}(e,2)||function(e,t){if(e){if("string"==typeof e)return eg(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return eg(e,t)}}(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),s=u[0],p=u[1],f=_().importSettingsSchema;return(0,g.useEffect)(function(){p(f)},[i.address,null==a?void 0:null===(n=a["x-action-settings"])||void 0===n?void 0:n.importSettings]),{title:l("Importable fields"),schema:eS({},s),initialValues:eS({},null!==(o=null==a?void 0:null===(r=a["x-action-settings"])||void 0===r?void 0:r.importSettings)&&void 0!==o?o:{}),components:{ArrayItems:M.ArrayItems},onSubmit:function(e){var t,n=e.importColumns,r=e.explain,o=null==n?void 0:n.filter(function(e){var t;return null==e?void 0:null===(t=e.dataIndex)||void 0===t?void 0:t.length}).map(function(e){return{dataIndex:e.dataIndex.map(function(e){var t;return null!==(t=e.name)&&void 0!==t?t:e}),title:e.title,description:e.description}});a["x-action-settings"].importSettings={importColumns:o,explain:r},c.emit("patch",{schema:(ex(t={},"x-uid",a["x-uid"]),ex(t,"x-action-settings",a["x-action-settings"]),t)}),c.refresh()}}}},{name:"divider",type:"divider"},{name:"delete",type:"remove",useComponentProps:function(){return{removeParentsIfNoChildren:!0,breakRemoveOn:function(e){return"Space"===e["x-component"]||e["x-component"].endsWith("ActionBar")},confirm:{title:(0,(0,S.useTranslation)().t)("Delete action")}}}}]});function eO(e,t,n,r,o,i,a){try{var l=e[i](a),c=l.value}catch(e){n(e);return}l.done?t(c):Promise.resolve(c).then(r,o)}function ew(e,t,n){return(ew=eE()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&eP(o,n.prototype),o}).apply(null,arguments)}function eA(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ej(e){return(ej=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function eP(e,t){return(eP=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function eC(e){var t="function"==typeof Map?new Map:void 0;return(eC=function(e){var n;if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;if("function"!=typeof e)throw TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return ew(e,arguments,ej(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),eP(r,e)})(e)}function eE(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(eE=function(){return!!e})()}var eT=function(e){var t,n,r;function o(){var e,t,n;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,o),e=this,t=o,n=arguments,t=ej(t),function(e,t){return t&&("object"===function(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}(t)||"function"==typeof t)?t:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,eE()?Reflect.construct(t,n||[],ej(e).constructor):t.apply(e,n))}return!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&eP(e,t)}(o,e),t=o,n=[{key:"load",value:function(){var e,t=this;return(e=function(){var e,n;return function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(i){return function(l){return function(i){if(n)throw TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,l])}}}(this,function(r){return t.app.use(eb),e={title:"{{t('Import')}}",Component:"ImportActionInitializer",schema:{"x-align":"right","x-decorator":"ACLActionProvider","x-acl-action":"importXlsx","x-acl-action-props":{skipScopeCheck:!0}},useVisible:function(){return(0,h.useActionAvailable)("import")}},null==(n=t.app.schemaInitializerManager.get("table:configureActions"))||n.add("enableActions.import",e),t.app.schemaInitializerManager.addItem("gantt:configureActions","enableActions.import",e),t.app.schemaSettingsManager.add(eI),[2]})},function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){eO(i,r,o,a,l,"next",e)}function l(e){eO(i,r,o,a,l,"throw",e)}a(void 0)})})()}}],eA(t.prototype,n),o}(eC(h.Plugin)),eD=eT;return v}()});