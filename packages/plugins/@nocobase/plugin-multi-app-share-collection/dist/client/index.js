/**
 * This file is part of the NocoBase (R) project.
 * Copyright (c) 2020-2024 NocoBase Co., Ltd.
 * Authors: NocoBase Team.
 *
 * This project is dual-licensed under AGPL-3.0 and NocoBase Commercial License.
 * For more information, please refer to: https://www.nocobase.com/agreement.
 */

!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("react-i18next"),require("@formily/react"),require("@nocobase/utils/client"),require("@nocobase/plugin-multi-app-manager/client"),require("@nocobase/client"),require("react"),require("antd")):"function"==typeof define&&define.amd?define("@nocobase/plugin-multi-app-share-collection",["react-i18next","@formily/react","@nocobase/utils/client","@nocobase/plugin-multi-app-manager/client","@nocobase/client","react","antd"],t):"object"==typeof exports?exports["@nocobase/plugin-multi-app-share-collection"]=t(require("react-i18next"),require("@formily/react"),require("@nocobase/utils/client"),require("@nocobase/plugin-multi-app-manager/client"),require("@nocobase/client"),require("react"),require("antd")):e["@nocobase/plugin-multi-app-share-collection"]=t(e["react-i18next"],e["@formily/react"],e["@nocobase/utils/client"],e["@nocobase/plugin-multi-app-manager/client"],e["@nocobase/client"],e.react,e.antd)}(self,function(e,t,n,r,o,a,i){return function(){"use strict";var c={505:function(e){e.exports=t},772:function(e){e.exports=o},801:function(e){e.exports=r},584:function(e){e.exports=n},721:function(e){e.exports=i},156:function(e){e.exports=a},238:function(t){t.exports=e}},l={};function u(e){var t=l[e];if(void 0!==t)return t.exports;var n=l[e]={exports:{}};return c[e](n,n.exports,u),n.exports}u.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return u.d(t,{a:t}),t},u.d=function(e,t){for(var n in t)u.o(t,n)&&!u.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},u.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},u.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};u.r(s),u.d(s,{PluginMultiAppShareCollectionClient:function(){return H},default:function(){return J}});var f=u("772"),p=u("505"),d=u("801"),m=u("721"),y=u("156"),b=u.n(y),h=u("584"),v=u("238");function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function w(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){var r,o,a;r=e,o=t,a=n[t],o in r?Object.defineProperty(r,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):r[o]=a})}return e}function S(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n.push.apply(n,r)}return n})(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}),e}function x(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n,r,o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var a=[],i=!0,c=!1;try{for(o=o.call(e);!(i=(n=o.next()).done)&&(a.push(n.value),!t||a.length!==t);i=!0);}catch(e){c=!0,r=e}finally{try{!i&&null!=o.return&&o.return()}finally{if(c)throw r}}return a}}(e,t)||j(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function O(e,t){return!t&&(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function C(e){return function(e){if(Array.isArray(e))return g(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||j(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function j(e,t){if(e){if("string"==typeof e)return g(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return g(e,t)}}function A(){var e=O(["\n          .ant-table-tbody > tr.ant-table-row:hover > td {\n            background: #e6f7ff;\n            cursor: pointer;\n          }\n        "]);return A=function(){return e},e}function E(){var e=O(["\n              display: flex;\n              justify-content: space-between;\n              align-items: center;\n              width: 100%;\n              margin-bottom: 8px;\n            "]);return E=function(){return e},e}function P(){var e=O(["\n              display: flex;\n              justify-content: space-between;\n              align-items: center;\n              width: 100%;\n              margin-bottom: 8px;\n            "]);return P=function(){return e},e}var k=["users","roles","applications"],q=function(e){var t=e.removed,n=void 0===t?[]:t,r=(0,f.useCollectionManager_deprecated)().collections;return{findAddable:(0,y.useCallback)(function(e){return h.CollectionsGraph.connectedNodes({collections:r,nodes:[e],excludes:k}).filter(function(e){return n.includes(e)})},[n]),findRemovable:(0,y.useCallback)(function(e){return h.CollectionsGraph.connectedNodes({collections:r,nodes:[e],excludes:k,direction:"reverse"}).filter(function(e){return!n.includes(e)})},[n])}},T=function(){var e,t,n=(0,f.useRecord)(),r=x((0,y.useState)([]),2),o=r[0],a=r[1],i=(0,f.useRequest)({url:"applications/".concat(n.name,"/collectionBlacklist:list"),params:{paginate:!1,params:{fields:["name"]}}},{onSuccess:function(e){var t;a(null===(t=e.data)||void 0===t?void 0:t.map(function(e){return e.name}))}}),c=(0,f.useRequest)({url:"collections",params:{fields:["name","title","hidden","category.name","category.color","category.sort"],sort:"sort",paginate:!1}}),l=(0,f.useRequest)({url:"collectionCategories",params:{sort:"sort",paginate:!1}});return{loading:i.loading||c.loading||l.loading,collections:((null===(e=c.data)||void 0===e?void 0:e.data)||[]).filter(function(e){return!e.hidden&&!k.includes(e.name)}),removed:o,setSelected:a,categories:((null===(t=l.data)||void 0===t?void 0:t.data)||[]).map(function(e){return{label:e.name,value:e.name}})}},R=function(e,t){var n=Array.isArray(t)?t:[t],r=!0,o=!1,a=void 0;try{for(var i,c=n[Symbol.iterator]();!(r=(i=c.next()).done);r=!0){var l=i.value;if(e.toLowerCase().includes(l))return!0}}catch(e){o=!0,a=e}finally{try{!r&&null!=c.return&&c.return()}finally{if(o)throw a}}return!1},F=function(e){var t=e.collections,n=e.removed,r=x((0,y.useState)({name:"",category:[]}),2),o=r[0],a=r[1];return{dataSource:(0,y.useMemo)(function(){return t.filter(function(e){var t=e.name,r=e.title,a=e.category,i=[n.includes(e.name)];return o.name&&i.push(R(t,o.name)||R(r,o.name)),o.category.length>0&&i.push((void 0===a?[]:a).some(function(e){return R(e.name,o.category)})),!i.includes(!1)})},[t,n,o]),setNameFilter:(0,y.useMemo)(function(){return h.lodash.debounce(function(e){a(S(w({},o),{name:e}))},300)},[]),setCategoryFilter:function(e){a(S(w({},o),{category:e}))}}},I=function(e){var t=e.collections,n=e.removed,r=x((0,y.useState)({name:"",category:[]}),2),o=r[0],a=r[1];return{dataSource:t.filter(function(e){var t=e.name,r=e.title,a=e.category,i=[!n.includes(e.name)];return o.name&&i.push(R(t,o.name)||R(r,o.name)),o.category.length>0&&i.push((void 0===a?[]:a).some(function(e){return R(e.name,o.category)})),!i.includes(!1)}),setNameFilter:(0,y.useMemo)(function(){return h.lodash.debounce(function(e){a(S(w({},o),{name:e}))},300)},[]),setCategoryFilter:function(e){a(S(w({},o),{category:e}))}}},M=(0,p.connect)(function(e){var t=e.onChange,n=T(),r=n.loading,o=n.collections,a=n.categories,i=n.removed,c=n.setSelected,l=x((0,y.useState)([]),2),u=l[0],s=l[1],p=x((0,y.useState)([]),2),d=p[0],g=p[1],w=q({removed:i}),S=w.findAddable,O=w.findRemovable,j=I({collections:o,removed:i}),k=F({collections:o,removed:i}),R=(0,v.useTranslation)("multi-app-share-collection").t,M=m.App.useApp().modal,_=(0,f.useToken)().token,z=(0,y.useMemo)(function(){return[{title:R("Collection display name"),dataIndex:"title"},{title:R("Collection name"),dataIndex:"name"},{title:R("Collection category"),dataIndex:"category",render:function(e){return e.map(function(e){return b().createElement(m.Tag,{key:e.name,color:e.color},e.name)})}}]},[]);return r?b().createElement(m.Spin,null):b().createElement("div",null,b().createElement(m.Row,{gutter:24,className:(0,f.css)(A())},b().createElement(m.Col,{span:12},b().createElement("div",{className:(0,f.css)(E())},b().createElement("strong",{style:{fontSize:_.fontSizeLG,color:_.colorText}},R("Unshared collections")),b().createElement(m.Input.Group,{compact:!0,style:{width:360}},b().createElement(m.Select,{popupMatchSelectWidth:!1,onChange:function(e){k.setCategoryFilter(e)},mode:"multiple",style:{width:"35%"},size:"middle",placeholder:R("All categories"),options:a,allowClear:!0}),b().createElement(m.Input,{onChange:function(e){return k.setNameFilter(e.target.value)},style:{width:"65%"},placeholder:R("Enter name or title..."),allowClear:!0}))),b().createElement(m.Table,{bordered:!0,rowKey:"name",rowSelection:{type:"checkbox",selectedRowKeys:u,onChange:function(e){var n=i.filter(function(t){return!e.includes(t)});c(n),t(n),s([])}},pagination:!1,size:"small",columns:z,dataSource:k.dataSource,scroll:{y:"calc(100vh - 260px)"},onRow:function(e){var n=e.name,r=e.disabled;return{onClick:function(){if(!r){var e=S(n),a=function(){var n=i.filter(function(t){return!e.includes(t)});c(n),t(n)};if(1===e.length)return a();M.confirm({title:R("Are you sure to add the following collections?"),width:"60%",content:b().createElement("div",null,b().createElement(m.Table,{size:"small",columns:z,dataSource:o.filter(function(t){return e.includes(t.name)}),pagination:!1,scroll:{y:"60vh"}})),onOk:function(){a()}})}}}}})),b().createElement(m.Col,{span:12},b().createElement("div",{className:(0,f.css)(P())},b().createElement("strong",{style:{fontSize:_.fontSizeLG,color:_.colorText}},R("Shared collections")),b().createElement(m.Input.Group,{compact:!0,style:{width:360}},b().createElement(m.Select,{popupMatchSelectWidth:!1,onChange:function(e){j.setCategoryFilter(e)},mode:"multiple",style:{width:"35%"},size:"middle",placeholder:R("All categories"),options:a,allowClear:!0}),b().createElement(m.Input,{onChange:function(e){return j.setNameFilter(e.target.value)},style:{width:"65%"},placeholder:R("Enter name or title..."),allowClear:!0}))),b().createElement(m.Table,{bordered:!0,rowKey:"name",rowSelection:{type:"checkbox",selectedRowKeys:d,onChange:function(e){var n=h.lodash.uniq(i.concat(e));c(n),t(n),g([])}},pagination:!1,size:"small",columns:z,dataSource:j.dataSource,scroll:{y:"calc(100vh - 260px)"},onRow:function(e){var n=e.name;return{onClick:function(){var e=O(n),r=function(){i.push.apply(i,C(e));var n=h.lodash.uniq(C(i));c(n),t(n)};if(1===e.length)return r();M.confirm({title:R("Are you sure to remove the following collections?"),width:"60%",content:b().createElement("div",null,b().createElement(m.Table,{size:"small",columns:z,dataSource:o.filter(function(t){return e.includes(t.name)}),pagination:!1,scroll:{y:"60vh"}})),onOk:function(){r()}})}}}}))))}),_=function(e){return'{{t("'.concat(e,"\", { ns: 'multi-app-share-collection' })}}")};function z(e,t,n,r,o,a,i){try{var c=e[a](i),l=c.value}catch(e){n(e);return}c.done?t(l):Promise.resolve(l).then(r,o)}var N=d.tableActionColumnSchema.properties.update,G=d.tableActionColumnSchema.properties.delete;delete d.tableActionColumnSchema.properties.update,delete d.tableActionColumnSchema.properties.delete,d.tableActionColumnSchema.properties.collection={type:"void",title:_("Share collections"),"x-component":"Action.Link","x-component-props":{},properties:{drawer:{type:"void","x-component":"Action.Drawer","x-component-props":{width:"95vw"},"x-decorator":"Form",title:_("Share collections"),properties:{names:{type:"array","x-component":M,"x-decorator":"FormItem"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{cancel:{title:'{{t("Cancel")}}',"x-component":"Action","x-component-props":{useAction:"{{ cm.useCancelAction }}"}},submit:{title:'{{t("Submit")}}',"x-component":"Action","x-component-props":{type:"primary",useAction:function(){var e=(0,p.useForm)(),t=(0,f.useActionContext)(),n=(0,f.useAPIClient)(),r=(0,f.useRecord)();return{run:function(){var o;return(o=function(){return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(a){return function(c){return function(a){if(n)throw TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}(this,function(o){switch(o.label){case 0:return console.log(e.values.names),[4,n.request({url:"applications/".concat(r.name,"/collectionBlacklist"),data:e.values.names,method:"post"})];case 1:return o.sent(),t.setVisible(!1),e.reset(),m.message.success("Saved successfully"),[2]}})},function(){var e=this,t=arguments;return new Promise(function(n,r){var a=o.apply(e,t);function i(e){z(a,n,r,i,c,"next",e)}function c(e){z(a,n,r,i,c,"throw",e)}i(void 0)})})()}}}}}}}}}}},d.tableActionColumnSchema.properties.update=N,d.tableActionColumnSchema.properties.delete=G;var D=function(e){return b().createElement(b().Fragment,null,e.children)};function B(e,t,n,r,o,a,i){try{var c=e[a](i),l=c.value}catch(e){n(e);return}c.done?t(l):Promise.resolve(l).then(r,o)}function K(e,t,n){return(K=$()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&W(o,n.prototype),o}).apply(null,arguments)}function L(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function U(e){return(U=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function W(e,t){return(W=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function V(e){var t="function"==typeof Map?new Map:void 0;return(V=function(e){var n;if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;if("function"!=typeof e)throw TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return K(e,arguments,U(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),W(r,e)})(e)}function $(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return($=function(){return!!e})()}var H=function(e){var t,n,r;function o(){var e,t,n;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,o),e=this,t=o,n=arguments,t=U(t),function(e,t){return t&&("object"===function(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}(t)||"function"==typeof t)?t:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,$()?Reflect.construct(t,n||[],U(e).constructor):t.apply(e,n))}return!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&W(e,t)}(o,e),t=o,n=[{key:"load",value:function(){var e,t=this;return(e=function(){return function(e,t){var n,r,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function c(a){return function(c){return function(a){if(n)throw TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,r=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}(this,function(e){return t.app.use(D),[2]})},function(){var t=this,n=arguments;return new Promise(function(r,o){var a=e.apply(t,n);function i(e){B(a,r,o,i,c,"next",e)}function c(e){B(a,r,o,i,c,"throw",e)}i(void 0)})})()}}],L(t.prototype,n),o}(V(f.Plugin)),J=H;return s}()});