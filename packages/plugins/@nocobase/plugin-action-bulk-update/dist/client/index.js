/**
 * This file is part of the NocoBase (R) project.
 * Copyright (c) 2020-2024 NocoBase Co., Ltd.
 * Authors: NocoBase Team.
 *
 * This project is dual-licensed under AGPL-3.0 and NocoBase Commercial License.
 * For more information, please refer to: https://www.nocobase.com/agreement.
 */

!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("react-i18next"),require("antd"),require("@formily/react"),require("@nocobase/utils/client"),require("@nocobase/client"),require("react")):"function"==typeof define&&define.amd?define("@nocobase/plugin-action-bulk-update",["react-i18next","antd","@formily/react","@nocobase/utils/client","@nocobase/client","react"],t):"object"==typeof exports?exports["@nocobase/plugin-action-bulk-update"]=t(require("react-i18next"),require("antd"),require("@formily/react"),require("@nocobase/utils/client"),require("@nocobase/client"),require("react")):e["@nocobase/plugin-action-bulk-update"]=t(e["react-i18next"],e.antd,e["@formily/react"],e["@nocobase/utils/client"],e["@nocobase/client"],e.react)}(self,function(e,t,n,r,o,i){return function(){"use strict";var a={505:function(e){e.exports=n},772:function(e){e.exports=o},584:function(e){e.exports=r},721:function(e){e.exports=t},156:function(e){e.exports=i},238:function(t){t.exports=e}},u={};function c(e){var t=u[e];if(void 0!==t)return t.exports;var n=u[e]={exports:{}};return a[e](n,n.exports,c),n.exports}c.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return c.d(t,{a:t}),t},c.d=function(e,t){for(var n in t)c.o(t,n)&&!c.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},c.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},c.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var l={};c.r(l),c.d(l,{PluginActionBulkUpdateClient:function(){return B},default:function(){return R}});var s=c("772"),p=c("505"),f=c("238"),d=c("156"),b=c.n(d);function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=[{name:"editButton",Component:s.ActionDesigner.ButtonEditor,useComponentProps:function(){return(0,s.useSchemaToolbar)().buttonEditorProps}},{name:"updateMode",Component:function(){var e,t=(0,s.useDesignable)().dn,n=(0,f.useTranslation)().t,r=(0,p.useFieldSchema)();return b().createElement(s.SchemaSettingsSelectItem,{title:n("Data will be updated"),options:[{label:n("Selected"),value:"selected"},{label:n("Entire collection",{ns:"action-bulk-edit"}),value:"all"}],value:null==r?void 0:null===(e=r["x-action-settings"])||void 0===e?void 0:e.updateMode,onChange:function(e){r["x-action-settings"].updateMode=e,t.emit("patch",{schema:{"x-uid":r["x-uid"],"x-action-settings":r["x-action-settings"]}}),t.refresh()}})},useVisible:function(){return["customize:bulkUpdate","customize:bulkEdit"].includes((0,p.useFieldSchema)()["x-action"])}},{name:"assignFieldValues",Component:s.AssignedFieldValues},{name:"afterSuccess",Component:function(){var e,t=(0,s.useDesignable)().dn,n=(0,f.useTranslation)().t,r=(0,p.useFieldSchema)();return b().createElement(s.SchemaSettingsModalItem,{title:n("After successful submission"),initialValues:null==r?void 0:null===(e=r["x-action-settings"])||void 0===e?void 0:e.onSuccess,schema:{type:"object",title:n("After successful submission"),properties:{successMessage:{title:n("Popup message"),"x-decorator":"FormItem","x-component":"Input.TextArea","x-component-props":{}},manualClose:{title:n("Popup close method"),enum:[{label:n("Automatic close"),value:!1},{label:n("Manually close"),value:!0}],"x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{}},redirecting:{title:n("Then"),enum:[{label:n("Stay on current page"),value:!1},{label:n("Redirect to"),value:!0}],"x-decorator":"FormItem","x-component":"Radio.Group","x-component-props":{},"x-reactions":{target:"redirectTo",fulfill:{state:{visible:"{{!!$self.value}}"}}}},redirectTo:{title:n("Link"),"x-decorator":"FormItem","x-component":"Input","x-component-props":{}}}},onSubmit:function(e){var n;r["x-action-settings"].onSuccess=e,t.emit("patch",{schema:(m(n={},"x-uid",r["x-uid"]),m(n,"x-action-settings",r["x-action-settings"]),n)})}})}},{name:"refreshDataBlockRequest",Component:s.RefreshDataBlockRequest,useComponentProps:function(){return{isPopupAction:!1}}},{name:"remove",sort:100,Component:s.ActionDesigner.RemoveButton,useComponentProps:function(){return(0,s.useSchemaToolbar)().removeButtonProps}}],v=new s.SchemaSettings({name:"ActionSettings:customize:bulkUpdate",items:y}),g=new s.SchemaSettings({name:"actionSettings:bulkUpdate",items:y}),h=function(){var e,t,n=(0,s.useSchemaInitializerItem)();return b().createElement(s.BlockInitializer,(e=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){var r,o,i;r=e,o=t,i=n[t],o in r?Object.defineProperty(r,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):r[o]=i})}return e}({},n),t=(t={schema:{type:"void",title:'{{ t("Bulk update") }}',"x-component":"Action","x-use-component-props":"useCustomizeBulkUpdateActionProps","x-align":"right","x-acl-action":"update","x-decorator":"ACLActionProvider","x-acl-action-props":{skipScopeCheck:!0},"x-action":"customize:bulkUpdate","x-toolbar":"ActionSchemaToolbar","x-settings":"actionSettings:bulkUpdate","x-action-settings":{assignedValues:{},updateMode:"selected",onSuccess:{manualClose:!0,redirecting:!1,successMessage:'{{t("Updated successfully")}}'}},"x-component-props":{icon:"EditOutlined"}},item:n},t),Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n.push.apply(n,r)}return n})(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}),e))},O=function(){var e,t,n=(0,s.useSchemaInitializerItem)();return b().createElement(s.BlockInitializer,(e=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){var r,o,i;r=e,o=t,i=n[t],o in r?Object.defineProperty(r,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):r[o]=i})}return e}({},n),t=(t={item:n},t),Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n.push.apply(n,r)}return n})(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}),e))},x=c("584"),S=c("721");function w(e,t,n,r,o,i,a){try{var u=e[i](a),c=u.value}catch(e){n(e);return}u.done?t(c):Promise.resolve(c).then(r,o)}function P(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){w(i,r,o,a,u,"next",e)}function u(e){w(i,r,o,a,u,"throw",e)}a(void 0)})}}function j(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function k(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}var C=function(){var e=(0,s.useBlockRequestContext)(),t=e.field,n=e.resource,r=e.__parent,o=e.service,i=(0,d.useContext)(p.SchemaExpressionScopeContext),a=(0,p.useFieldSchema)(),u=(0,s.useTableBlockContext)(),c=u.rowKey,l=(0,s.useNavigateNoUpdate)(),b=(0,s.useCompile)(),m=(0,f.useTranslation)("action-bulk-update",{nsMode:"fallback"}).t,y=(0,p.useField)(),v=S.App.useApp().modal,g=(0,s.useVariables)(),h=(0,s.useCollection_deprecated)(),O=(h.name,h.getField),w=(0,s.useLocalVariables)();return{onClick:function(e,p){return P(function(){var e,f,d,h,C,T,A,M,I,E,U,z;return k(this,function(B){switch(B.label){case 0:var R;return T=void 0===(C=(h=null!==(d=null==a?void 0:a["x-action-settings"])&&void 0!==d?d:{}).assignedValues)?{}:C,A=h.onSuccess,M=h.updateMode,y.data=t.data||{},y.data.loading=!0,U=null!==(E=null!==(I=null===(f=u.field)||void 0===f?void 0:null===(e=f.data)||void 0===e?void 0:e.selectedRowKeys)&&void 0!==I?I:null==i?void 0:i.selectedRecordKeys)&&void 0!==E?E:{},z={},[4,Promise.all(Object.keys(T).map((R=P(function(e){var t,n,r;return k(this,function(o){switch(o.label){case 0:t=T[e],n=O(e);if(!(0,s.isVariable)(t))return[3,2];return[4,null==g?void 0:g.parseVariable(t,w).then(function(e){return e.value})];case 1:return(r=o.sent())&&(z[e]=(0,s.transformVariableValue)(r,{targetCollectionField:n})),[3,3];case 2:null!=t&&""!==t&&(z[e]=t),o.label=3;case 3:return[2]}})}),function(e){return R.apply(this,arguments)})))];case 1:return B.sent(),v.confirm({title:m("Bulk update",{ns:"client"}),content:"selected"===M?m("Update selected data?",{ns:"client"}):m("Update all data?",{ns:"client"}),onOk:function(){return P(function(){var e,t,i,a,u,f,d;return k(this,function(u){switch(u.label){case 0:if(i=(null!==(t=null===(e=o.params)||void 0===e?void 0:e[0])&&void 0!==t?t:{}).filter,a={values:function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){j(e,t,n[t])})}return e}({},z),filter:i,forceUpdate:!1},"selected"===M){if(!(null==U?void 0:U.length))return S.message.error(m("Please select the records to be updated")),y.data.loading=!1,[2];a.filter={$and:[j({},c||"id",{$in:U})]}}!a.filter&&(a.forceUpdate=!0),u.label=1;case 1:return u.trys.push([1,3,4,5]),[4,n.update(a)];case 2:case 3:return u.sent(),[3,5];case 4:return y.data.loading=!1,[7];case 5:var g,h;if(p&&(null==p||p()),g=n,null!=(h=s.TableFieldResource)&&"undefined"!=typeof Symbol&&h[Symbol.hasInstance]?!h[Symbol.hasInstance](g):!(g instanceof h))null==r||null===(d=r.service)||void 0===d||null===(f=d.refresh)||void 0===f||f.call(d);if(!(null==A?void 0:A.successMessage))return[2];return(null==A?void 0:A.manualClose)?v.success({title:b(null==A?void 0:A.successMessage),onOk:P(function(){return k(this,function(e){return(null==A?void 0:A.redirecting)&&(null==A?void 0:A.redirectTo)&&((0,x.isURL)(A.redirectTo)?window.location.href=A.redirectTo:l(A.redirectTo)),[2]})})}):(S.message.success(b(null==A?void 0:A.successMessage)),(null==A?void 0:A.redirecting)&&(null==A?void 0:A.redirectTo)&&((0,x.isURL)(A.redirectTo)?window.location.href=A.redirectTo:l(A.redirectTo))),[2]}})})()},onCancel:function(){return P(function(){return k(this,function(e){return y.data.loading=!1,[2]})})()}}),[2]}})})()}}};function T(e,t,n,r,o,i,a){try{var u=e[i](a),c=u.value}catch(e){n(e);return}u.done?t(c):Promise.resolve(c).then(r,o)}function A(e,t,n){return(A=z()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&E(o,n.prototype),o}).apply(null,arguments)}function M(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function I(e){return(I=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function E(e,t){return(E=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function U(e){var t="function"==typeof Map?new Map:void 0;return(U=function(e){var n;if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;if("function"!=typeof e)throw TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return A(e,arguments,I(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),E(r,e)})(e)}function z(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(z=function(){return!!e})()}var B=function(e){var t,n,r;function o(){var e,t,n;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,o),e=this,t=o,n=arguments,t=I(t),function(e,t){return t&&("object"===function(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}(t)||"function"==typeof t)?t:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,z()?Reflect.construct(t,n||[],I(e).constructor):t.apply(e,n))}return!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&E(e,t)}(o,e),t=o,n=[{key:"load",value:function(){var e,t=this;return(e=function(){var e;return function(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}(this,function(n){return t.app.addComponents({CustomizeActionInitializer:O}),t.app.addScopes({useCustomizeBulkUpdateActionProps:C}),t.app.addScopes({useCustomizeBulkUpdateActionProps:C}),t.app.schemaSettingsManager.add(v),t.app.schemaSettingsManager.add(g),e={title:'{{t("Bulk update")}}',Component:h,name:"bulkUpdate",useVisible:function(){return(0,s.useActionAvailable)("updateMany")}},t.app.schemaInitializerManager.addItem("table:configureActions","customize.bulkUpdate",e),t.app.schemaInitializerManager.addItem("gantt:configureActions","customize.bulkUpdate",e),t.app.schemaInitializerManager.addItem("map:configureActions","customize.bulkUpdate",e),[2]})},function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){T(i,r,o,a,u,"next",e)}function u(e){T(i,r,o,a,u,"throw",e)}a(void 0)})})()}}],M(t.prototype,n),o}(U(s.Plugin)),R=B;return l}()});