/**
 * This file is part of the NocoBase (R) project.
 * Copyright (c) 2020-2024 NocoBase Co., Ltd.
 * Authors: NocoBase Team.
 *
 * This project is dual-licensed under AGPL-3.0 and NocoBase Commercial License.
 * For more information, please refer to: https://www.nocobase.com/agreement.
 */

"use strict";(self.webpackChunk_nocobase_plugin_data_source_manager=self.webpackChunk_nocobase_plugin_data_source_manager||[]).push([["833"],{227:function(e,t,n){n.d(t,{E:function(){return s}});var r=n(482),i=n(772),a=n(505),l=n(721),o=n(156),c=n.n(o),u=n(286),s=function(e){var t=(0,i.useCollectionRecordData)()||{},n=(0,i.useCompile)();return(0,a.useField)().editable?c().createElement(i.Input,e):(null==t?void 0:t.filterTargetKey)?n(t.title):c().createElement("div",{style:{display:"inline"}},c().createElement(l.Popover,{trigger:["click"],content:c().createElement(u.L,{size:"small",style:{width:"20em"}})},c().createElement(r.ExclamationCircleTwoTone,{style:{marginRight:"0.3em"},twoToneColor:"#faad14"})),n(t.title))}},648:function(e,t,n){n.d(t,{a:function(){return u}});var r=n(772),i=n(721),a=n(156),l=n.n(a),o=n(128),c=n(286),u=function(e){var t=e.collectionName,n=(0,r.useApp)(),u=(0,o.useParams)().name,s=void 0===u?"main":u,f=(0,a.useMemo)(function(){return n.getCollectionManager(s).getCollection(t)},[n,s,t]);return!(null==f?void 0:f.filterTargetKey)&&l().createElement(i.Alert,{style:{marginBottom:16},type:"warning",message:l().createElement(c.L,null)})}},286:function(e,t,n){n.d(t,{L:function(){return m}});var r=n(772),i=n(721),a=n(156),l=n.n(a),o=n(128),c=n(573),u=n(550);function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function f(e,t,n,r,i,a,l){try{var o=e[a](l),c=o.value}catch(e){n(e);return}o.done?t(c):Promise.resolve(c).then(r,i)}function d(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n,r,i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var a=[],l=!0,o=!1;try{for(i=i.call(e);!(l=(n=i.next()).done)&&(a.push(n.value),!t||a.length!==t);l=!0);}catch(e){o=!0,r=e}finally{try{!l&&null!=i.return&&i.return()}finally{if(o)throw r}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return s(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return s(e,t)}}(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var m=function(e){var t,n=e.size,s=e.style,m=(0,r.useAPIClient)(),p=(0,o.useParams)().name,y=void 0===p?"main":p,h=(0,r.useCollectionRecordData)(),b=(0,r.useApp)(),g=d((0,a.useState)(),2),v=g[0],w=g[1],x=d((0,a.useState)(),2),E=x[0],S=x[1],C=(0,r.useCompile)(),A=(0,a.useMemo)(function(){return b.getCollectionManager(y).getCollection(h.name)},[b,y,h.name]),I=(0,a.useMemo)(function(){return b.getCollectionManager(y).getCollectionFields(h.name).filter(function(e){if(!e.interface)return!1;var t=b.dataSourceManager.collectionFieldInterfaceManager.getFieldInterface(e.interface);return(null==t?!!void 0:!!t.titleUsable)||!1}).map(function(e){var t;return{label:C(null===(t=e.uiSchema)||void 0===t?void 0:t.title),value:e.name}})},[b,C,y,h.name]),k=(0,r.useResourceActionContext)().refresh,O=(0,a.useContext)(u.I),F=(0,c.EL)().t;return l().createElement("div",{style:function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){var r,i,a;r=e,i=t,a=n[t],i in r?Object.defineProperty(r,i,{value:a,enumerable:!0,configurable:!0,writable:!0}):r[i]=a})}return e}({},s)},F("If a collection lacks a primary key, you must configure a unique record key to locate row records within a block, failure to configure this will prevent the creation of data blocks for the collection."),"small"===n?l().createElement("br",null):" ",l().createElement(i.Space.Compact,{style:{marginTop:5}},l().createElement(i.Select,{onChange:function(e,t){console.log(e,t),w(e),S(t.map(function(e){return e.label}).join(","))},placeholder:F("Select field"),size:"small",options:I,mode:"multiple",style:{width:"200px"}}),l().createElement(i.Popconfirm,{placement:"bottom",title:l().createElement("div",{style:{width:"15em"}},E?F('Are you sure you want to set the "{{title}}" field as a record unique key? This setting cannot be changed after it\'s been set.',{title:E}):F("Please select a field.")),onConfirm:(t=function(){var e;return function(e,t){var n,r,i,a,l={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(n)throw TypeError("Generator is already executing.");for(;l;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return l.label++,{value:a[1],done:!1};case 5:l.label++,r=a[1],a=[0];continue;case 7:a=l.ops.pop(),l.trys.pop();continue;default:if(!(i=(i=l.trys).length>0&&i[i.length-1])&&(6===a[0]||2===a[0])){l=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){l.label=a[1];break}if(6===a[0]&&l.label<i[1]){l.label=i[1],i=a;break}if(i&&l.label<i[2]){l.label=i[2],l.ops.push(a);break}i[2]&&l.ops.pop(),l.trys.pop();continue}a=t.call(e,l)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}}(this,function(t){switch(t.label){case 0:if(!v)return[2];if("main"!==y)return[3,2];return[4,m.request({url:"collections:update?filterByTk=".concat(h.name),method:"post",data:{filterTargetKey:v}})];case 1:return t.sent(),[3,4];case 2:return[4,m.request({url:"dataSources/".concat(y,"/collections:update?filterByTk=").concat(h.name),method:"post",data:{filterTargetKey:v}})];case 3:t.sent(),t.label=4;case 4:return null==O||null===(e=O.refresh)||void 0===e||e.call(O),k(),[4,b.dataSourceManager.getDataSource(y).reload()];case 5:return t.sent(),A.setOption("filterTargetKey",v),[2]}})},function(){var e=this,n=arguments;return new Promise(function(r,i){var a=t.apply(e,n);function l(e){f(a,r,i,l,o,"next",e)}function o(e){f(a,r,i,l,o,"throw",e)}l(void 0)})})},l().createElement(i.Button,{type:"primary",size:"small"},F("OK")))))}},550:function(e,t,n){n.d(t,{f:function(){return M},I:function(){return k}});var r=n("964"),i=n("563"),a=n("505"),l=n("772"),o=n("721"),c=n("156"),u=n.n(c),s=n("238"),f=n("648");function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function m(e,t,n,r,i,a,l){try{var o=e[a](l),c=o.value}catch(e){n(e);return}o.done?t(c):Promise.resolve(c).then(r,i)}function p(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var a=e.apply(t,n);function l(e){m(a,r,i,l,o,"next",e)}function o(e){m(a,r,i,l,o,"throw",e)}l(void 0)})}}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){y(e,t,n[t])})}return e}function b(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n.push.apply(n,r)}return n})(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}),e}function g(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n,r,i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var a=[],l=!0,o=!1;try{for(i=i.call(e);!(l=(n=i.next()).done)&&(a.push(n.value),!t||a.length!==t);l=!0);}catch(e){o=!0,r=e}finally{try{!l&&null!=i.return&&i.return()}finally{if(o)throw r}}return a}}(e,t)||w(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(e,t){return!t&&(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function w(e,t){if(e){if("string"==typeof e)return d(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return d(e,t)}}function x(e,t){var n,r,i,a,l={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(a){return function(o){return function(a){if(n)throw TypeError("Generator is already executing.");for(;l;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return l.label++,{value:a[1],done:!1};case 5:l.label++,r=a[1],a=[0];continue;case 7:a=l.ops.pop(),l.trys.pop();continue;default:if(!(i=(i=l.trys).length>0&&i[i.length-1])&&(6===a[0]||2===a[0])){l=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){l.label=a[1];break}if(6===a[0]&&l.label<i[1]){l.label=i[1],i=a;break}if(i&&l.label<i[2]){l.label=i[2],l.ops.push(a);break}i[2]&&l.ops.pop(),l.trys.pop();continue}a=t.call(e,l)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,o])}}}function E(){var e=v(["\n  .ant-table {\n    margin-left: -16px !important;\n  }\n"]);return E=function(){return e},e}function S(){var e=v(["\n  tr {\n    display: flex;\n  }\n  td,\n  th {\n    flex: 2.3;\n    width: 0;\n    &:nth-child(5) {\n      flex: 1.2;\n    }\n    &:last-child {\n      flex: 1.5;\n    }\n  }\n  .ant-table-selection-column,\n  .ant-table-row-expand-icon-cell {\n    flex-basis: 50px !important;\n    min-width: 50px;\n    flex: 0;\n  }\n"]);return S=function(){return e},e}function C(){var e=v(["\n            font-weight: 500;\n          "]);return C=function(){return e},e}function A(){var e=v(["\n            justify-content: flex-end;\n            display: flex;\n            margin-bottom: 16px;\n          "]);return A=function(){return e},e}var I={association:{sourceKey:"name",targetKey:"name"},collection:{name:"fields",fields:[{type:"string",name:"type",interface:"input",uiSchema:{title:'{{ t("Storage type") }}',type:"string","x-component":"Select",enum:[{label:"String",value:"string"}],required:!0}},{type:"string",name:"interface",interface:"input",uiSchema:{title:'{{ t("Field interface") }}',type:"string","x-component":"Select",enum:"{{interfaces}}"}},{type:"string",name:"title",interface:"input",uiSchema:{title:'{{ t("Field display name") }}',type:"string","x-component":"Input",required:!0}},{type:"string",name:"name",interface:"input",uiSchema:{title:'{{ t("Field name") }}',type:"string","x-component":"Input"}},{type:"string",name:"description",interface:"input",uiSchema:{title:'{{ t("Description") }}',type:"string","x-component":"Input.TextArea"}}]},request:{resource:"collections.fields",action:"list",params:{paginate:!1,filter:{$or:[{"interface.$not":null},{"options.source.$notEmpty":!0}]},sort:["sort"]}}},k=(0,c.createContext)(null),O=function(e){return u().createElement(k.Provider,{value:(0,l.useResourceActionContext)()},u().createElement(l.ResourceActionProvider,I,e.children))},F=(0,r.css)(E()),P=(0,r.css)(S()),T="Default title for each record",j=function(e){var t=(0,l.useCompile)(),n=(0,l.useCollectionManager_deprecated)().getInterface,r=(0,s.useTranslation)().t,i=(0,l.useResourceActionContext)().setState,a=(e.collectionResource||{}).targetKey,f=(0,l.useRecord)(),d=g(u().useState(null),2),m=d[0],v=d[1],w=(0,l.useCollectionManager_deprecated)(),E=w.refreshCM,S=w.isTitleField,C=w.getTemplate,A=f[a],I=f.titleField,O=C(f.template),P=(0,l.useAPIClient)(),j=(0,c.useContext)(k),R=[{dataIndex:["uiSchema","title"],title:r("Field display name"),render:function(e){return u().createElement("div",{style:{marginLeft:7}},t(e))}},{dataIndex:"name",title:r("Field name")},{dataIndex:"interface",title:r("Field interface"),render:function(e){var r;return u().createElement(o.Tag,null,t(null===(r=n(e))||void 0===r?void 0:r.title))}},{dataIndex:"titleField",title:r("Title field"),render:function(t,n){var i,a=(i=p(function(t){var i;return x(this,function(a){switch(a.label){case 0:return v(n),[4,P.request({url:"collections:update?filterByTk=".concat(A),method:"post",data:{titleField:t?n.name:"id"}})];case 1:return a.sent(),null==j||null===(i=j.refresh)||void 0===i||i.call(j),[4,e.refreshAsync()];case 2:return a.sent(),v(null),E(),o.message.success(r("Saved successfully")),[2]}})}),function(e){return i.apply(this,arguments)});return S(n)?u().createElement(o.Tooltip,{title:r(T),placement:"right",overlayInnerStyle:{textAlign:"center"}},u().createElement(o.Switch,{"aria-label":"switch-title-field-".concat(n.name),size:"small",loading:n.name===(null==m?void 0:m.name),checked:n.name===(I||"id"),onChange:a})):null}},{dataIndex:"description",title:r("Descriptio "),render:function(e){return u().createElement(l.Input.ReadPretty,{value:e,ellipsis:!0})}},{dataIndex:"actions",title:r("Actions"),render:function(e,t){var n={confirm:{title:r("Delete record"),content:r("Are you sure you want to delete it?")},useAction:l.useDestroyActionAndRefreshCM,disabled:(0,l.isDeleteButtonDisabled)(t)||(null==O?void 0:O.forbidDeletion),title:r("Delete")};return u().createElement(l.RecordProvider,{record:t,parent:f},u().createElement(o.Space,{size:"middle"},u().createElement(l.EditCollectionField,{role:"button","aria-label":"edit-button-".concat(t.name),type:"primary"}),u().createElement(l.Action.Link,n)))}}];return u().createElement(o.Table,{rowKey:"name",columns:R,showHeader:!1,pagination:!1,dataSource:e.fields,rowSelection:{type:"checkbox",getCheckboxProps:function(e){return{"aria-label":"checkbox-".concat(e.name)}},onChange:function(t){i(function(n){return b(h({},n),y({},e.type,t))})}},className:F})},R=function(e){var t=(0,l.useCompile)(),n=(0,l.useCollectionManager_deprecated)().getInterface,r=(e.collectionResource||{}).targetKey,i=(0,l.useRecord)(),a=g(u().useState(null),2),f=a[0],d=a[1],m=(0,s.useTranslation)().t,y=(0,l.useCollectionManager_deprecated)(),h=y.refreshCM,b=y.isTitleField,v=i[r],w=i.titleField,E=i.name,S=(0,c.useContext)(k),C=(0,l.useAPIClient)(),A=[{dataIndex:["uiSchema","rawTitle"],title:m("Field display name"),render:function(e){return u().createElement("div",{style:{marginLeft:1}},t(e))}},{dataIndex:"name",title:m("Field name")},{dataIndex:"interface",title:m("Field interface"),render:function(e){var r;return u().createElement(o.Tag,null,t(null===(r=n(e))||void 0===r?void 0:r.title))}},{dataIndex:"titleField",title:m("Title field"),render:function(t,n){var r,i=(r=p(function(t){var r;return x(this,function(i){switch(i.label){case 0:return d(n),[4,C.request({url:"collections:update?filterByTk=".concat(v),method:"post",data:{titleField:t?n.name:"id"}})];case 1:return i.sent(),null==S||null===(r=S.refresh)||void 0===r||r.call(S),[4,e.refreshAsync()];case 2:return i.sent(),d(null),h(),o.message.success(m("Saved successfully")),[2]}})}),function(e){return r.apply(this,arguments)});return b(n)?u().createElement(o.Tooltip,{title:m(T),placement:"right",overlayInnerStyle:{textAlign:"center"}},u().createElement(o.Switch,{size:"small",loading:n.name===(null==f?void 0:f.name),checked:n.name===(w||"id"),onChange:i})):null}},{dataIndex:"actions",title:m("Actions"),render:function(e,t){return u().createElement(l.RecordProvider,{record:t,parent:i},u().createElement(o.Space,null,u().createElement(l.OverridingCollectionField,{type:"primary",currentCollection:E}),u().createElement(l.ViewCollectionField,{type:"primary"})))}}];return u().createElement(o.Table,{rowKey:"name",columns:A,showHeader:!1,pagination:!1,dataSource:e.fields.filter(function(e){return e.interface})})},D=function(){var e,t=(0,l.useCompile)(),n=(0,a.useField)(),m=(0,l.useRecord)(),p=m.name,y=m.template,g=((0,l.useCurrentAppInfo)()||{data:{database:{}}}).data.database,v=(0,l.useCollectionManager_deprecated)(),x=v.getInterface,E=v.getInheritCollections,S=v.getCollection,I=v.getTemplate,k=(0,c.useMemo)(function(){return(0,i.createForm)()},[]),O=(0,l.useAttach)(k.createArrayField(b(h({},n.props),{basePath:""}))),F=(0,s.useTranslation)().t,T=(0,l.useResourceContext)(),D=(0,c.useContext)(l.ResourceActionContext),M=D.refreshAsync,K=D.data,_=I(y),q=E(p),z=[{dataIndex:"title",title:F("Field display name"),render:function(e){return u().createElement("div",{className:(0,r.css)(C())},e)}},{dataIndex:"name",title:F("Field name")},{dataIndex:"interface",title:F("Field interface")},{dataIndex:"titleField",title:F("Title field")},{dataIndex:"description",title:F("Description")},{dataIndex:"actions",title:F("Actions")}],B=(null==K?void 0:K.data)||[],L={pf:[],association:[],general:[],system:[]};B.forEach(function(e){if(e.primaryKey||e.isForeignKey)L.pf.push(e);else if(e.interface){var t=x(e.interface);(null==t?void 0:t.group)==="systemInfo"?L.system.push(e):(null==t?void 0:t.group)==="relation"?L.association.push(e):L.general.push(e)}});var N=[{key:"pf",title:F("PK & FK fields"),fields:L.pf},{key:"association",title:F("Association fields"),fields:L.association},{key:"general",title:F("General fields"),fields:L.general},{key:"system",title:F("System fields"),fields:L.system}];N.push.apply(N,function(e){if(Array.isArray(e))return d(e)}(e=q.map(function(e){var n=S(e);if(!!n)return{key:e,title:"".concat(F("Inherited fields")," - ")+t(null==n?void 0:n.title),inherit:!0,fields:(null==n?void 0:n.fields)||[]}}).filter(Boolean))||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||w(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}());var $=(0,c.useMemo)(function(){return{useAction:function(){return(0,l.useBulkDestroyActionAndRefreshCM)(!0)},title:F("Delete"),icon:"DeleteOutlined",disabled:null==_?void 0:_.forbidDeletion,confirm:{title:F("Delete record"),content:F("Are you sure you want to delete it?")}}},[F]);return u().createElement(a.FormContext.Provider,{value:k},u().createElement(a.FieldContext.Provider,{value:O},u().createElement(f.a,{collectionName:p}),u().createElement(o.Space,{align:"end",className:(0,r.css)(A())},u().createElement(l.Action,$),u().createElement(l.SyncFieldsAction,{type:"primary"}),u().createElement(l.SyncSQLFieldsAction,{refreshCMList:M}),u().createElement(l.SchemaComponent,{schema:{type:"object",properties:h({},_.configureActions)}}),u().createElement(l.AddCollectionField,{type:"primary",database:g})),u().createElement(o.Table,{rowKey:"key",columns:z,dataSource:N.filter(function(e){return e.fields.length}),pagination:!1,className:P,expandable:{defaultExpandAllRows:!0,defaultExpandedRowKeys:N.map(function(e){return e.key}),expandedRowRender:function(e){return e.inherit?u().createElement(R,{fields:e.fields,collectionResource:T,refreshAsync:M}):u().createElement(j,{fields:e.fields,collectionResource:T,refreshAsync:M,type:e.key})}}})))},M=function(){return u().createElement(O,null,u().createElement(D,null))}}}]);