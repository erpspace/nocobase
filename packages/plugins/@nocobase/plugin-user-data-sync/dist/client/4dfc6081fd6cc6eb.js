/**
 * This file is part of the NocoBase (R) project.
 * Copyright (c) 2020-2024 NocoBase Co., Ltd.
 * Authors: NocoBase Team.
 *
 * This project is dual-licensed under AGPL-3.0 and NocoBase Commercial License.
 * For more information, please refer to: https://www.nocobase.com/agreement.
 */

"use strict";(self.webpackChunk_nocobase_plugin_user_data_sync=self.webpackChunk_nocobase_plugin_user_data_sync||[]).push([["157"],{700:function(e,t,o){o.r(t),o.d(t,{UserDataSyncSource:function(){return N}});var n=o("482"),r=o("563"),c=o("505"),i=o("772"),a=o("721"),s=o("156"),l=o.n(s),u=o("60");function p(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),n.forEach(function(t){var n,r,c;n=e,r=t,c=o[t],r in n?Object.defineProperty(n,r,{value:c,enumerable:!0,configurable:!0,writable:!0}):n[r]=c})}return e}var m=function(e){var t,o,n=(0,i.useCollectionRecordData)();var r=(0,i.useRequest)(function(){return Promise.resolve({data:p({},n.options)})},(t=p({},e),o=(o={manual:!0},o),Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):(function(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);o.push.apply(o,n)}return o})(Object(o)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}),t)),c=r.run,a=(0,i.useActionContext)();return(0,s.useEffect)(function(){a.visible&&c()},[a.visible,c]),r},y=function(e){var t,o=(0,i.usePlugin)(u.default).sourceTypes.get(e);return null==o?void 0:null===(t=o.components)||void 0===t?void 0:t.AdminSettingsForm},d=(0,c.observer)(function(){var e=(0,c.useForm)(),t=(0,i.useCollectionRecordData)(),o=y(e.values.sourceType||t.sourceType);return o?l().createElement(o,null):null},{displayName:"Options"}),f=o("573"),b={name:"userDataSyncSources",sortable:!0,filterTargetKey:"id",fields:[{name:"id",type:"string",interface:"id"},{interface:"input",type:"string",name:"name",uiSchema:{type:"string",title:'{{t("Source name")}}',"x-component":"Input",required:!0}},{interface:"input",type:"string",name:"sourceType",allowNull:!1,uiSchema:{type:"string",title:'{{t("Type")}}',"x-component":"Select",required:!0,dataSource:"{{ types }}"}},{type:"boolean",name:"enabled",uiSchema:{type:"boolean",title:'{{t("Enabled")}}',"x-component":"Checkbox"}}]},v={name:"userDataSyncTasks",filterTargetKey:"id",fields:[{name:"id",type:"bigInt",interface:"id"},{name:"batch",interface:"input",type:"string",allowNull:!1,uiSchema:{type:"string",title:'{{t("Batch")}}',"x-component":"Input",required:!0}},{name:"source",interface:"input",type:"belongsTo",target:"userDataSyncSources",targetKey:"id",foreignKey:"sourceId",allowNull:!1,uiSchema:{type:"object",title:'{{t("Source")}}',"x-component":"AssociationField","x-component-props":{fieldNames:{value:"id",label:"name"}},required:!0,"x-read-pretty":!0}},{name:"status",interface:"input",type:"string",allowNull:!1,uiSchema:{type:"string",title:'{{t("Status")}}',"x-component":"Select",required:!0,enum:[{label:'{{t("Init")}}',value:"init",color:"default"},{label:'{{t("Processing")}}',value:"processing",color:"processing"},{label:'{{t("Success")}}',value:"success",color:"success"},{label:'{{t("Failed")}}',value:"failed",color:"error"}]}},{name:"message",interface:"input",type:"string",allowNull:!0,uiSchema:{type:"string",title:'{{t("Message")}}',"x-component":"Input",required:!1}},{name:"cost",interface:"input",type:"integer",allowNull:!0,uiSchema:{type:"integer",title:'{{t("Cost")}}',"x-component":"InputNumber","x-component-props":{precision:0},required:!1}}]},x={type:"object",properties:{drawer:{type:"void","x-component":"Action.Drawer",title:'{{t("Add new")}}',properties:{form:{type:"void","x-component":"FormV2","x-use-component-props":"useCustomFormProps",properties:{name:{"x-component":"CollectionField","x-decorator":"FormItem"},sourceType:{"x-component":"CollectionField","x-decorator":"FormItem","x-component-props":{options:"{{ types }}"}},enabled:{"x-component":"CollectionField","x-decorator":"FormItem"},options:{type:"object","x-component":"Options"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{submit:{title:'{{t("Submit")}}',"x-component":"Action","x-use-component-props":"useSubmitActionProps","x-component-props":{type:"primary"}}}}}}}}}},g={type:"object",properties:{drawer:{type:"void","x-component":"Action.Drawer",title:'{{ t("Tasks") }}',properties:{table:{type:"void","x-decorator":"TableBlockProvider","x-use-decorator-props":"useTasksTableBlockProps","x-decorator-props":{collection:v.name,dragSort:!1,action:"list",showIndex:!0},properties:{table:{type:"array","x-component":"TableV2","x-use-component-props":"useTableBlockProps","x-component-props":{rowKey:"id"},properties:{batch:{type:"void",title:'{{ t("Batch") }}',"x-component":"TableV2.Column",properties:{batch:{type:"string","x-component":"CollectionField","x-pattern":"readPretty"}}},status:{type:"void",title:'{{ t("Status") }}',"x-component":"TableV2.Column",properties:{status:{type:"string","x-component":"CollectionField","x-pattern":"readPretty"}}},message:{type:"void",title:'{{ t("Message") }}',"x-component":"TableV2.Column",properties:{message:{type:"string","x-component":"Message"}}},actions:{type:"void",title:'{{t("Actions")}}',"x-decorator":"TableV2.Column.ActionBar","x-component":"TableV2.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{sync:{type:"void","x-component":"Retry"}}}}}}}}}}}}},h={type:"void",name:"userDataSyncSources","x-component":"CardItem","x-decorator":"TableBlockProvider","x-decorator-props":{collection:b.name,dragSort:!1,action:"list",params:{pageSize:10},showIndex:!0},properties:{actions:{type:"void","x-component":"ActionBar","x-component-props":{style:{marginBottom:16}},properties:{delete:{type:"void",title:'{{t("Delete")}}',"x-component":"Action","x-use-component-props":"useBulkDestroyActionProps","x-component-props":{icon:"DeleteOutlined",confirm:{title:"{{t('Delete')}}",content:"{{t('Are you sure you want to delete it?')}}"}}},create:{type:"void",title:'{{t("Add new")}}',"x-component":"AddNew","x-component-props":{type:"primary"}}}},table:{type:"array","x-component":"TableV2","x-use-component-props":"useTableBlockProps","x-component-props":{rowKey:"id",rowSelection:{type:"checkbox"}},properties:{name:{type:"void",title:'{{t("Source name")}}',"x-component":"TableV2.Column",properties:{name:{type:"string","x-component":"CollectionField","x-pattern":"readPretty"}}},sourceType:{type:"void",title:'{{t("Type")}}',"x-component":"TableV2.Column",properties:{sourceType:{type:"string","x-component":"Select","x-pattern":"readPretty",enum:"{{ types }}"}}},enabled:{type:"void",title:'{{t("Enabled")}}',"x-component":"TableV2.Column",properties:{enabled:{type:"boolean","x-component":"CollectionField","x-pattern":"readPretty"}}},actions:{type:"void",title:'{{t("Actions")}}',"x-decorator":"TableV2.Column.ActionBar","x-component":"TableV2.Column",properties:{actions:{type:"void","x-component":"Space","x-component-props":{split:"|"},properties:{sync:{type:"void",title:'{{ t("Sync") }}',"x-component":"Action.Link","x-use-component-props":"useSyncActionProps"},tasks:{type:"void",title:'{{ t("Tasks") }}',"x-component":"Tasks","x-component-props":{type:"primary"}},edit:{type:"void",title:'{{t("Configure")}}',"x-component":"Action.Link","x-component-props":{type:"primary",openMode:"drawer"},properties:{drawer:{type:"void","x-component":"Action.Drawer",title:'{{t("Configure")}}',properties:{form:{type:"void","x-component":"FormV2","x-use-component-props":"useEditFormProps",properties:{name:{"x-component":"CollectionField","x-decorator":"FormItem"},sourceType:{"x-component":"CollectionField","x-decorator":"FormItem","x-component-props":{options:"{{ types }}"}},enabled:{"x-component":"CollectionField","x-decorator":"FormItem"},options:{type:"object","x-component":"Options"},footer:{type:"void","x-component":"Action.Drawer.Footer",properties:{submit:{title:'{{t("Submit")}}',"x-component":"Action","x-use-component-props":"useSubmitActionProps","x-component-props":{type:"primary"}}}}}}}}}},delete:{type:"void",title:'{{ t("Delete") }}',"x-component":"Action.Link","x-use-component-props":"useDeleteActionProps"}}}}}}}}},S=(0,s.createContext)({type:""});S.displayName="SourceTypeContext";var C=(0,s.createContext)({types:[]});C.displayName="SourceTypesContext";function P(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,n=Array(t);o<t;o++)n[o]=e[o];return n}function w(e,t,o,n,r,c,i){try{var a=e[c](i),s=a.value}catch(e){o(e);return}a.done?t(s):Promise.resolve(s).then(n,r)}function A(e){return function(){var t=this,o=arguments;return new Promise(function(n,r){var c=e.apply(t,o);function i(e){w(c,n,r,i,a,"next",e)}function a(e){w(c,n,r,i,a,"throw",e)}i(void 0)})}}function k(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var o,n,r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var c=[],i=!0,a=!1;try{for(r=r.call(e);!(i=(o=r.next()).done)&&(c.push(o.value),!t||c.length!==t);i=!0);}catch(e){a=!0,n=e}finally{try{!i&&null!=r.return&&r.return()}finally{if(a)throw n}}return c}}(e,t)||function(e,t){if(e){if("string"==typeof e)return P(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);if("Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o)return Array.from(o);if("Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o))return P(e,t)}}(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function T(e,t){var o,n,r,c,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return c={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function a(c){return function(a){return function(c){if(o)throw TypeError("Generator is already executing.");for(;i;)try{if(o=1,n&&(r=2&c[0]?n.return:c[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,c[1])).done)return r;switch(n=0,r&&(c=[2&c[0],r.value]),c[0]){case 0:case 1:r=c;break;case 4:return i.label++,{value:c[1],done:!1};case 5:i.label++,n=c[1],c=[0];continue;case 7:c=i.ops.pop(),i.trys.pop();continue;default:if(!(r=(r=i.trys).length>0&&r[r.length-1])&&(6===c[0]||2===c[0])){i=0;continue}if(3===c[0]&&(!r||c[1]>r[0]&&c[1]<r[3])){i.label=c[1];break}if(6===c[0]&&i.label<r[1]){i.label=r[1],r=c;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(c);break}r[2]&&i.ops.pop(),i.trys.pop();continue}c=t.call(e,i)}catch(e){c=[6,e],n=0}finally{o=r=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,a])}}}var O=function(){var e=(0,i.useCollectionRecordData)();return{form:(0,s.useMemo)(function(){return(0,r.createForm)({values:e})},[])}},D=function(){var e=(0,i.useActionContext)().setVisible,t=(0,c.useForm)(),o=(0,i.useDataBlockResource)(),n=(0,i.useDataBlockRequestGetter)().getDataBlockRequest,r=(0,i.useCollection)();return{type:"primary",onClick:function(){return A(function(){var c,i;return T(this,function(a){switch(a.label){case 0:return[4,t.submit()];case 1:if(a.sent(),!(i=t.values)[r.filterTargetKey])return[3,3];return[4,o.update({values:i,filterByTk:i[r.filterTargetKey]})];case 2:return a.sent(),[3,5];case 3:return[4,o.create({values:i})];case 4:a.sent(),a.label=5;case 5:return[4,null===(c=n())||void 0===c?void 0:c.runAsync()];case 6:return a.sent(),e(!1),[2]}})})()}}};function E(){var e=(0,i.useCollectionRecordData)(),t=(0,i.useDataBlockResource)(),o=(0,i.useCollection)(),n=(0,i.useDataBlockRequestGetter)().getDataBlockRequest,r=(0,f.S)().t;return{confirm:{title:r("Delete",{ns:f.A}),content:r("Are you sure you want to delete it?",{ns:f.A})},onClick:function(){return A(function(){var r;return T(this,function(c){switch(c.label){case 0:return[4,t.destroy({filterByTk:e[o.filterTargetKey]})];case 1:return c.sent(),[4,null===(r=n())||void 0===r?void 0:r.runAsync()];case 2:return c.sent(),[2]}})})()}}}function j(){var e=a.App.useApp().message,t=(0,i.useCollectionRecordData)(),o=(0,i.useAPIClient)(),n=(0,i.useDataBlockRequestGetter)().getDataBlockRequest,r=(0,f.S)().t;return{hidden:!(null==t?void 0:t.enabled),onClick:function(){return A(function(){var c;return T(this,function(i){switch(i.label){case 0:return[4,o.resource("userData").pull({name:t.name})];case 1:return i.sent(),[4,null===(c=n())||void 0===c?void 0:c.runAsync()];case 2:return i.sent(),e.success(r("The synchronization has started. You can click on 'Tasks' to view the synchronization status.",{ns:f.A})),[2]}})})()}}}var F=function(){var e=(0,s.useContext)(S).type;return{form:(0,s.useMemo)(function(){return(0,r.createForm)({initialValues:{sourceType:e}})},[])}},I=function(){return{params:{pageSize:20,filter:{sourceId:(0,i.useCollectionRecordData)()[(0,i.useCollection)().filterTargetKey]},sort:["-sort"]}}};function R(){var e=(0,i.useCollectionRecordData)(),t=(0,i.useCollection)(),o=(0,i.useAPIClient)(),n=(0,i.useDataBlockRequestGetter)().getDataBlockRequest;return{onClick:function(){return A(function(){var r;return T(this,function(c){switch(c.label){case 0:return[4,o.resource("userData").retry({id:e[t.filterTargetKey],sourceId:e.sourceId})];case 1:return c.sent(),[4,null===(r=n())||void 0===r?void 0:r.runAsync()];case 2:return c.sent(),[2]}})})()}}}var B=function(){var e=(0,f.S)().t,t=(0,i.useAPIClient)(),o=k((0,s.useState)(!1),2),r=o[0],c=o[1],u=k((0,s.useState)(""),2),p=u[0],m=u[1],y=(0,s.useContext)(C).types,d=y.map(function(e){var t,o;return t=function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),n.forEach(function(t){var n,r,c;n=e,r=t,c=o[t],r in n?Object.defineProperty(n,r,{value:c,enumerable:!0,configurable:!0,writable:!0}):n[r]=c})}return e}({},e),o=(o={onClick:function(){c(!0),m(e.value)}},o),Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):(function(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);o.push.apply(o,n)}return o})(Object(o)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}),t}),b=[{key:"__empty__",label:l().createElement(a.Empty,{image:a.Empty.PRESENTED_IMAGE_SIMPLE,description:l().createElement(l().Fragment,null,e("No user data source plugin installed",{ns:f.A}),l().createElement("br",null)," ",l().createElement("a",{target:"_blank",href:"zh-CN"===t.auth.locale?"https://docs-cn.nocobase.com/handbook/user-data-sync":"https://docs.nocobase.com/handbook/user-data-sync",rel:"noreferrer"},e("View documentation",{ns:f.A})))}),onClick:function(){}}];return l().createElement(i.ActionContextProvider,{value:{visible:r,setVisible:c}},l().createElement(S.Provider,{value:{type:p}},l().createElement(a.Dropdown,{menu:{items:d&&d.length>0?d:b}},l().createElement(a.Button,{icon:l().createElement(n.PlusOutlined,null),type:"primary"},e("Add new")," ",l().createElement(n.DownOutlined,null))),l().createElement(i.SchemaComponent,{scope:{types:y,setType:m,useCustomFormProps:F},schema:x})))},V=function(){var e=(0,f.S)().t,t=(0,i.useCollectionRecordData)();return l().createElement(i.ReadPretty.Input,{value:e(t.message),ellipsis:!0})},q=function(){var e=(0,i.useCollectionRecordData)(),t=(0,f.S)().t,o=k((0,s.useState)(!1),2),n=o[0],r=o[1];return e.enabled?l().createElement(i.ActionContextProvider,{value:{visible:n,setVisible:r}},l().createElement(a.Button,{type:"link",onClick:function(){r(!0)}},t("Tasks")),l().createElement(i.ExtendCollectionsProvider,{collections:[v]},l().createElement(i.SchemaComponent,{scope:{useRetryActionProps:R,useTasksTableBlockProps:I,t:t},components:{Message:V},schema:g}))):null},_=function(){var e=(0,f.S)().t;return"failed"!==(0,i.useCollectionRecordData)().status?null:l().createElement(i.SchemaComponent,{scope:{t:e},schema:{type:"void",properties:{retry:{title:'{{ t("Retry") }}',"x-component":"Action.Link","x-use-component-props":"useRetryActionProps"}}}})},N=function(){var e=(0,f.S)().t,t=k((0,s.useState)([]),2),o=t[0],n=t[1],r=(0,i.useAPIClient)();return(0,i.useRequest)(function(){return r.resource("userData").listSyncTypes().then(function(t){var o;return((null==t?void 0:null===(o=t.data)||void 0===o?void 0:o.data)||[]).map(function(t){return{key:t.name,label:c.Schema.compile(t.title||t.name,{t:e}),value:t.name}})})},{onSuccess:function(e){n(e)}}),l().createElement(C.Provider,{value:{types:o}},l().createElement(i.ExtendCollectionsProvider,{collections:[b]},l().createElement(i.SchemaComponent,{schema:h,components:{AddNew:B,Options:d,Tasks:q,Retry:_},scope:{types:o,t:e,useEditFormProps:O,useSubmitActionProps:D,useDeleteActionProps:E,useSyncActionProps:j,useValuesFromOptions:m}})))}}}]);